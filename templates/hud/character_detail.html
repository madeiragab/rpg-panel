{% extends "base.html" %}
{% load static %}
{% load hud_filters %}

{% block content %}
{% if campaign and campaign_characters %}
<nav class="character-navbar">
    <div class="character-navbar-inner">
        {% for char in campaign_characters %}
        <a href="{% url 'character_detail' char.pk %}{% if not is_master %}?mode=player{% endif %}" class="character-nav-item {% if char.id == character.id %}active{% endif %}" title="{{ char.name }}">
            <span class="character-nav-avatar" style="background:{% if char.image %}url('{{ char.image.url }}'){% else %}#ffffff{% endif %}; background-size: cover; background-position: center;"></span>
            <span class="character-nav-name">{{ char.name }}</span>
        </a>
        {% endfor %}
        {% for npc in visible_npcs %}
        <a href="{% url 'npc_detail' npc.pk %}{% if not is_master %}?mode=player{% endif %}" class="character-nav-item" title="{{ npc.name }}">
            <span class="character-nav-avatar" style="background:{% if npc.image %}url('{{ npc.image.url }}'){% else %}#888888{% endif %}; background-size: cover; background-position: center;"></span>
            <span class="character-nav-name">{{ npc.name }}</span>
        </a>
        {% endfor %}
    </div>
</nav>
{% endif %}
<div style="padding: 12px 24px; max-width: 1400px; margin: 0 auto;">
    {% if campaign %}
        {% if is_master %}
        <a href="{% url 'campaign_detail' campaign.pk %}" class="hud-button ghost">Voltar para Campanha</a>
        {% else %}
        <a href="{% url 'campaign_detail' campaign.pk %}?mode=player" class="hud-button ghost">Voltar para Campanha</a>
        {% endif %}
    {% else %}
        <a href="{% url 'home' %}" class="hud-button ghost">Voltar</a>
    {% endif %}
</div>
<div class="hud-layout" {% if campaign and campaign.banner %}style="background-image: linear-gradient(rgba(12, 15, 26, 0.85), rgba(12, 15, 26, 0.85)), url('{{ campaign.banner.url }}'); background-size: cover; background-attachment: fixed; background-position: center;"{% endif %}>
    {% if not is_master %}
        <div class="player-view-notice">
            <p>üìñ Voc√™ est√° visualizando este personagem em modo leitura</p>
        </div>
    {% endif %}
    
    <section class="panel-card column">
        <h2 class="panel-title">Per√≠cias / Profici√™ncias</h2>
        <div class="tags-wrap">
            {% for skill in character.skills.all %}
                <span class="skill-tag">
                    {{ skill.name }}{% if skill.value %} <span class="skill-value">{{ skill.value }}</span>{% endif %}
                </span>
            {% empty %}
                <span class="muted">Sem per√≠cias cadastradas.</span>
            {% endfor %}
        </div>
        {% if is_master %}
            <form method="post" class="panel-form compact">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="skill">
                {{ skill_form.as_p }}
                <button type="submit" class="hud-button ghost">Adicionar per√≠cia</button>
            </form>
        {% endif %}
    </section>

    <section class="panel-card column">
        <div class="character-header">
            <h1 class="panel-title">{{ character.name }}</h1>
            {% if character.assigned_to %}
                <div class="list-inline" style="gap: 8px; align-items: center;">
                    <span class="mini-thumb" style="width:36px;height:36px;border-radius:50%;border:1px solid var(--border); background:{% if character.assigned_to.profile.avatar %}url('{{ character.assigned_to.profile.avatar.url }}'){% else %}#ffffff{% endif %}; background-size: cover; background-position: center;"></span>
                    <span class="muted">{{ character.assigned_to.username }}</span>
                    {% if is_master and character.campaign %}
                        <button id="toggle-player-select" type="button" class="hud-button ghost" style="padding:2px 6px; font-size:14px;">‚ñº</button>
                    {% endif %}
                </div>
                {% if is_master and character.campaign %}
                <div id="player-select-panel" style="display:none; margin-top:8px; padding:8px; background:rgba(20,26,42,0.4); border-radius:8px;">
                    <form method="post" class="panel-form compact">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="change_player">
                        <label for="new-player">Reatribuir para:</label>
                        <select id="new-player" name="assigned_to" required>
                            <option value="">Selecione um jogador</option>
                            {% for p in character.campaign.players.all %}
                                <option value="{{ p.id }}" {% if p.id == character.assigned_to.id %}selected{% endif %}>{{ p.username }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="hud-button" style="margin-top:8px;">Salvar</button>
                    </form>
                </div>
                {% endif %}
            {% endif %}
        </div>
        <div id="bars-container" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
            {% for bar in character.bars.all %}
            <div class="character-bar" data-bar-id="{{ bar.id }}" style="display: flex; align-items: center; gap: 12px;">
                <span style="font-weight: 600; min-width: 80px; color: var(--text);">{{ bar.name }}</span>
                <button class="hud-button ghost" onclick="modifyBar({{ bar.id }}, 'decrease')" style="padding: 4px 8px; font-size: 16px;">‚àí</button>
                <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                    <span class="bar-display" style="font-size: 0.9rem; color: var(--muted);">{{ bar.current }} / {{ bar.max_value }}</span>
                    <div style="width: 100%; height: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 5px; overflow: hidden;">
                        <div class="bar-fill" style="height: 100%; background: {{ bar.color }}; width: {{ bar.current|div:bar.max_value|mul:100 }}%; transition: width 0.3s ease;"></div>
                    </div>
                </div>
                <button class="hud-button ghost" onclick="modifyBar({{ bar.id }}, 'increase')" style="padding: 4px 8px; font-size: 16px;">+</button>
                {% if is_master %}
                <button class="hud-button danger" onclick="deleteBar({{ bar.id }})" style="padding: 4px 8px; font-size: 12px;">√ó</button>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        
        {% if is_master %}
        <div style="margin-bottom: 20px;">
            <button id="add-bar-btn" class="hud-button" onclick="showAddBarForm()" style="width: 100%;">+ Adicionar Barra</button>
            <div id="add-bar-form" style="display: none; margin-top: 12px; padding: 16px; background: var(--panel); border-radius: 8px;">
                <input type="text" id="bar-name" placeholder="Nome (ex: Vida, Mana, Sanidade)" style="width: 100%; padding: 8px; margin-bottom: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text);">
                <input type="number" id="bar-max" placeholder="Valor m√°ximo" value="100" style="width: 100%; padding: 8px; margin-bottom: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text);">
                <input type="color" id="bar-color" value="#ff4444" style="width: 100%; height: 40px; margin-bottom: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px;">
                <div style="display: flex; gap: 8px;">
                    <button class="hud-button" onclick="addBar({{ character.id }})">Criar</button>
                    <button class="hud-button ghost" onclick="hideAddBarForm()">Cancelar</button>
                </div>
            </div>
        </div>
        {% endif %}
        <div class="portrait-wrap">
            <div class="portrait-thumb{% if not character.image %} empty{% endif %}"
                 {% if character.image %}style="background-image: url('{{ character.image.url }}')"{% endif %}></div>
            <div class="portrait-hint muted">Retrato do personagem (opcional)</div>
        </div>
        
        <div class="attributes-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
            {% for attr in character.attributes.all %}
                <div class="attribute-box" style="background: rgba(20,26,42,0.4); padding: 8px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--muted); text-transform: uppercase;">{{ attr.name }}</div>
                    <div style="font-size: 1.1rem; font-weight: 600; color: var(--text);">{{ attr.value }}</div>
                </div>
            {% endfor %}
        </div>
        
        {% if is_master %}
            <form method="post" class="panel-form compact" style="margin-top: 12px;">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="attribute">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div>
                        <label for="id_attribute-name" style="display: block; font-size: 0.9rem; margin-bottom: 4px;">Nome</label>
                        <input type="text" name="attribute-name" placeholder="Ex: For√ßa, Intelig√™ncia" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: rgba(255,255,255,0.05); color: var(--text);">
                    </div>
                    <div>
                        <label for="id_attribute-value" style="display: block; font-size: 0.9rem; margin-bottom: 4px;">Valor</label>
                        <input type="text" name="attribute-value" placeholder="Ex: 18, A+, Excelente" style="width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: rgba(255,255,255,0.05); color: var(--text);">
                    </div>
                </div>
                <button type="submit" class="hud-button ghost" style="margin-top: 8px;">+ Atributo</button>
            </form>
        {% endif %}
        
        {% if is_master %}
            <form method="post" enctype="multipart/form-data" class="panel-form compact">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="character">
                {{ character_form.as_p }}
                <button type="submit" class="hud-button">Atualizar atributos</button>
            </form>
        {% endif %}

        <div class="abilities ability-box">
            <h3 class="panel-subtitle">Habilidades</h3>
            <div class="tags-wrap">
                {% for ability in character.abilities.all %}
                    <span class="ability-tag">{{ ability.name }}</span>
                {% empty %}
                    <span class="muted">Sem habilidades cadastradas.</span>
                {% endfor %}
            </div>
            {% if is_master %}
                <form method="post" class="panel-form compact">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="ability">
                    {{ ability_form.as_p }}
                    <button type="submit" class="hud-button ghost">Adicionar habilidade</button>
                </form>
            {% endif %}
        </div>
    </section>

    <section class="panel-card column">
        <div class="panel-subtitle" style="display: flex; align-items: center; gap: 10px;">
            <span>Invent√°rio ({{ character.slots.count }}/{{ character.inventory_capacity }})</span>
            {% if is_master %}
                <button id="add-item-btn" class="hud-button ghost" title="Adicionar item" style="padding: 2px 8px; line-height: 1;">+</button>
            {% endif %}
        </div>
        <div class="selected-item-display" id="selected-item-display">
            <div class="selected-item-figure empty" id="selected-figure"></div>
            <div class="selected-item-name" id="selected-name">Selecione um item</div>
        </div>
        {% if is_master %}
        <div id="item-picker" class="panel-card" style="display: none; padding: 8px;">
            <div class="item-pool" id="item-pool">
                {% for item in items %}
                    <div class="item-chip" data-item-id="{{ item.pk }}" data-item-image="{% if item.image %}{{ item.image.url }}{% endif %}">
                        <span class="item-thumb{% if not item.image %} empty{% endif %}"
                              {% if item.image %}style="background-image: url('{{ item.image.url }}')"{% endif %}></span>
                        <span class="item-name">{{ item.name }}</span>
                    </div>
                {% empty %}
                    <div class="muted">Nenhum item dispon√≠vel.</div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        <div class="inventory-grid-wrap">
            <div class="inventory-grid" id="inventory-grid" data-character-id="{{ character.pk }}">
                {% for slot in slots %}
                    <button
                        type="button"
                        class="inventory-slot"
                        data-slot-id="{{ slot.pk }}"
                        data-assign-url="{% url 'assign_slot' character.pk slot.pk %}"
                        data-item-name="{{ slot.item.name|default:'Vazio' }}"
                        data-item-image="{% if slot.item and slot.item.image %}{{ slot.item.image.url }}{% endif %}">
                        <div class="slot-figure{% if not slot.item or not slot.item.image %} empty{% endif %}"
                            {% if slot.item and slot.item.image %}style="background-image: url('{{ slot.item.image.url }}')"{% endif %}></div>
                        <span class="slot-label">{{ slot.label }}</span>
                    </button>
                {% endfor %}
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
    <script>window.hudConfig = { csrfToken: "{{ csrf_token }}" };</script>
    {% if is_master %}
        <script src="{% static 'hud/inventory.js' %}"></script>
    {% endif %}
    <script>
    // Toggle player select panel
    const toggleBtn = document.getElementById('toggle-player-select');
    const panel = document.getElementById('player-select-panel');
    if (toggleBtn && panel) {
        toggleBtn.addEventListener('click', () => {
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        });
    }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const figure = document.getElementById('selected-figure');
            const name = document.getElementById('selected-name');
            document.querySelectorAll('.inventory-slot').forEach((slot) => {
                slot.addEventListener('click', () => {
                    const itemName = slot.dataset.itemName || 'Vazio';
                    const itemImage = slot.dataset.itemImage || '';
                    name.textContent = itemName;
                    if (itemImage) {
                        figure.classList.remove('empty');
                        figure.style.backgroundImage = `url('${itemImage}')`;
                    } else {
                        figure.classList.add('empty');
                        figure.style.backgroundImage = '';
                    }
                });
            });
        });
    </script>
    <script>
    function modifyStat(characterId, statType, action) {
        const url = statType === 'hp' 
            ? `/characters/${characterId}/modify-hp/`
            : `/characters/${characterId}/modify-sp/`;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `action=${action}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const display = document.getElementById(`${statType}-display`);
                const bar = document.getElementById(`${statType}-bar`);
                const currentValue = statType === 'hp' ? data.hp_current : data.sp_current;
                const maxValue = parseInt(display.textContent.split(' / ')[1]);
                const percentage = (currentValue / maxValue) * 100;
                
                display.textContent = `${currentValue} / ${maxValue}`;
                bar.style.width = `${percentage}%`;
            } else {
                alert(data.error || 'Erro ao modificar');
            }
        })
        .catch(error => console.error('Erro:', error));
    }
    
    function showAddBarForm() {
        document.getElementById('add-bar-form').style.display = 'block';
        document.getElementById('add-bar-btn').style.display = 'none';
    }
    
    function hideAddBarForm() {
        document.getElementById('add-bar-form').style.display = 'none';
        document.getElementById('add-bar-btn').style.display = 'block';
    }
    
    function addBar(characterId) {
        const name = document.getElementById('bar-name').value.trim();
        const maxValue = document.getElementById('bar-max').value;
        const color = document.getElementById('bar-color').value;
        
        if (!name) {
            alert('Digite um nome para a barra');
            return;
        }
        
        fetch(`/characters/${characterId}/add-bar/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `name=${encodeURIComponent(name)}&max_value=${maxValue}&color=${encodeURIComponent(color)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Erro ao criar barra');
            }
        })
        .catch(error => console.error('Erro:', error));
    }
    
    function modifyBar(barId, action) {
        fetch(`/bars/${barId}/modify/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `action=${action}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const barEl = document.querySelector(`[data-bar-id="${barId}"]`);
                const display = barEl.querySelector('.bar-display');
                const fill = barEl.querySelector('.bar-fill');
                const maxValue = parseInt(display.textContent.split(' / ')[1]);
                const percentage = (data.current / maxValue) * 100;
                
                display.textContent = `${data.current} / ${maxValue}`;
                fill.style.width = `${percentage}%`;
            } else {
                alert(data.error || 'Erro ao modificar');
            }
        })
        .catch(error => console.error('Erro:', error));
    }
    
    function deleteBar(barId) {
        if (!confirm('Tem certeza que deseja deletar esta barra?')) return;
        
        fetch(`/bars/${barId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector(`[data-bar-id="${barId}"]`).remove();
            }
        })
        .catch(error => console.error('Erro:', error));
    }
    </script>
{% endblock %}
