{% extends "base.html" %}
{% load static %}

{% block content %}
<div style="padding: 12px 24px; max-width: 1400px; margin: 0 auto;">
    {% if campaign %}
        {% if is_master %}
        <a href="{% url 'campaign_detail' campaign.pk %}" class="hud-button ghost">Voltar para Campanha</a>
        {% else %}
        <a href="{% url 'campaign_detail' campaign.pk %}?mode=player" class="hud-button ghost">Voltar para Campanha</a>
        {% endif %}
    {% else %}
        <a href="{% url 'home' %}" class="hud-button ghost">Voltar</a>
    {% endif %}
</div>
<div class="hud-layout" {% if campaign and campaign.banner %}style="background-image: linear-gradient(rgba(12, 15, 26, 0.85), rgba(12, 15, 26, 0.85)), url('{{ campaign.banner.url }}'); background-size: cover; background-attachment: fixed; background-position: center;"{% endif %}>
    {% if not is_master %}
        <div class="player-view-notice">
            <p>üìñ Voc√™ est√° visualizando este NPC em modo leitura</p>
        </div>
    {% endif %}

    <section class="panel-card column">
        <h2 class="panel-title">Per√≠cias / Profici√™ncias</h2>
        <div class="tags-wrap">
            {% for skill in npc.skills.all %}
                <span class="skill-tag">
                    {{ skill.name }}{% if skill.value %} <span class="skill-value">{{ skill.value }}</span>{% endif %}
                </span>
            {% empty %}
                <span class="muted">Sem per√≠cias cadastradas.</span>
            {% endfor %}
        </div>
        {% if is_master %}
            <form method="post" class="panel-form compact">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="skill">
                {{ skill_form.as_p }}
                <button type="submit" class="hud-button ghost">Adicionar per√≠cia</button>
            </form>
        {% endif %}
    </section>

    <section class="panel-card column">
        <div class="character-header">
            <h1 class="panel-title">{{ npc.name }}</h1>
        </div>
        
        <div id="bars-container" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
            {% for bar in npc.bars.all %}
            <div class="character-bar" data-bar-id="{{ bar.id }}" style="display: flex; align-items: center; gap: 12px;">
                <span style="font-weight: 600; min-width: 80px; color: var(--text);">{{ bar.name }}</span>
                {% if is_master %}
                    <button class="hud-button ghost" onclick="modifyNPCBar({{ bar.id }}, 'decrease')" style="padding: 4px 8px; font-size: 16px;">‚àí</button>
                {% endif %}
                <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                    <span class="bar-display" style="font-size: 0.9rem; color: var(--muted);" data-current="{{ bar.current }}" data-max="{{ bar.max_value }}">{{ bar.current }} / {{ bar.max_value }}</span>
                    <div style="width: 100%; height: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 5px; overflow: hidden;">
                        <div class="bar-fill" style="height: 100%; background: {{ bar.color }}; width: {% widthratio bar.current bar.max_value 100 %}%; transition: width 0.3s ease;"></div>
                    </div>
                </div>
                {% if is_master %}
                    <button class="hud-button ghost" onclick="modifyNPCBar({{ bar.id }}, 'increase')" style="padding: 4px 8px; font-size: 16px;">+</button>
                    <button class="hud-button danger" onclick="deleteNPCBar({{ bar.id }})" style="padding: 4px 8px; font-size: 12px;">√ó</button>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <div class="portrait-wrap">
            <div class="portrait-thumb{% if not npc.image %} empty{% endif %}"
                 {% if npc.image %}style="background-image: url('{{ npc.image.url }}')"{% endif %}></div>
            <div class="portrait-hint muted">Retrato do NPC (opcional)</div>
        </div>

        <div class="attributes-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
            {% for attr in npc.attributes.all %}
                <div class="attribute-box" style="background: rgba(20,26,42,0.4); padding: 8px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--muted); text-transform: uppercase;">{{ attr.name }}</div>
                    <div style="font-size: 1.1rem; font-weight: 600; color: var(--text);">{{ attr.value }}</div>
                </div>
            {% endfor %}
        </div>

        {% if is_master %}
            <form method="post" class="panel-form compact" style="margin-top: 12px;">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="attribute">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    {{ attribute_form.name }}
                    {{ attribute_form.value }}
                </div>
                <button type="submit" class="hud-button ghost" style="margin-top: 8px;">+ Atributo</button>
            </form>

            <form method="post" enctype="multipart/form-data" class="panel-form compact" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="npc">
                {{ npc_form.as_p }}
                <button type="submit" class="hud-button">Atualizar informa√ß√µes</button>
            </form>

            <form method="post" class="panel-form" id="add-bar-form" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                {% csrf_token %}
                <h3 class="panel-subtitle">Adicionar Barra</h3>
                <label for="bar-name">Nome da barra</label>
                <input type="text" id="bar-name" placeholder="Ex.: Sanidade, Karma..." />
                <label for="bar-max">Valor m√°ximo</label>
                <input type="number" id="bar-max" value="100" min="1" />
                <label for="bar-color">Cor</label>
                <input type="color" id="bar-color" value="#70e0ff" />
                <button type="button" class="hud-button ghost" onclick="addNPCBar()">Adicionar</button>
            </form>
        {% endif %}
    </section>

    <section class="panel-card column">
        <h2 class="panel-title">Habilidades</h2>
        <div class="tags-wrap">
            {% for ability in npc.abilities.all %}
                <span class="ability-tag">
                    {{ ability.name }}
                </span>
            {% empty %}
                <span class="muted">Sem habilidades cadastradas.</span>
            {% endfor %}
        </div>
        {% if is_master %}
            <form method="post" class="panel-form compact">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="ability">
                {{ ability_form.as_p }}
                <button type="submit" class="hud-button ghost">Adicionar habilidade</button>
            </form>
        {% endif %}
    </section>

    <section class="panel-card column">
        <div class="list-inline" style="justify-content: space-between; align-items: center;">
            <h2 class="panel-title" style="margin: 0;">Invent√°rio</h2>
            <button type="button" class="hud-button ghost" id="toggle-npc-inventory" aria-expanded="false" style="padding: 4px 12px; font-size: 18px;">+</button>
        </div>
        <div id="npc-inventory" class="inventory-grid-wrap" style="display: none; margin-top: 12px;">
            <div class="inventory-grid" aria-live="polite" style="width: 100%; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
                {% for slot in slots %}
                    <div class="inventory-slot" style="cursor: default;">
                        <div class="slot-figure{% if not slot.item or not slot.item.image %} empty{% endif %}"
                             {% if slot.item and slot.item.image %}style="background-image: url('{{ slot.item.image.url }}')"{% endif %}></div>
                        <span class="slot-label">{{ slot.label }}</span>
                        {% if slot.item %}
                            <span class="muted" style="font-size: 0.85rem;">{{ slot.item.name }}</span>
                        {% else %}
                            <span class="muted" style="font-size: 0.85rem;">Vazio</span>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </section>
</div>

<script>
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

async function modifyNPCBar(barId, action) {
    fetch(`/npcs/{{ npc.id }}/${barId}/modify-bar/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken') || ''
        },
        body: new URLSearchParams({
            action: action,
        }).toString()
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const barElement = document.querySelector(`[data-bar-id="${barId}"]`);
            if (barElement) {
                const display = barElement.querySelector('.bar-display');
                const fill = barElement.querySelector('.bar-fill');
                const maxValue = parseInt(display.getAttribute('data-max')) || 100;
                display.textContent = `${data.current} / ${maxValue}`;
                const percentage = (data.current / maxValue) * 100;
                fill.style.width = `${percentage}%`;
            }
        }
    })
    .catch(error => console.error('Erro:', error));
}

async function addNPCBar() {
    const name = document.getElementById('bar-name').value.trim();
    const maxValue = parseInt(document.getElementById('bar-max').value) || 100;
    const color = document.getElementById('bar-color').value;
    
    if (!name) {
        alert('Digite o nome da barra');
        return;
    }
    
    fetch(`/npcs/{{ npc.id }}/add-bar/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken') || ''
        },
        body: new URLSearchParams({
            name: name,
            max_value: maxValue,
            color: color,
        }).toString()
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    })
    .catch(error => console.error('Erro:', error));
}

async function deleteNPCBar(barId) {
    if (!confirm('Tem certeza que deseja deletar esta barra?')) return;
    fetch(`/npcs/{{ npc.id }}/${barId}/delete-bar/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken') || ''
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    })
    .catch(error => console.error('Erro:', error));
}

// Toggle inventory visibility (default collapsed)
const toggleInventoryBtn = document.getElementById('toggle-npc-inventory');
const inventorySection = document.getElementById('npc-inventory');
if (toggleInventoryBtn && inventorySection) {
    toggleInventoryBtn.addEventListener('click', () => {
        const isOpen = inventorySection.style.display === 'block';
        inventorySection.style.display = isOpen ? 'none' : 'block';
        toggleInventoryBtn.textContent = isOpen ? '+' : '‚àí';
        toggleInventoryBtn.setAttribute('aria-expanded', (!isOpen).toString());
    });
}
</script>
{% endblock %}
